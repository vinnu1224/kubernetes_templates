**Install Vault cli by**

```

https://releases.hashicorp.com/vault/1.0.1/vault_1.0.1_linux_amd64.zip

```

**To unzip the file**

```

unzip vault_1.0.1_linux_amd64.zip

```

**To set VAULT_ADDR env variable by run the following command**

```

export VAULT_ADDR=https://localhost:8200

```
**create an approle**

* For creating approle first we have to write a policy and attach that policy to the role.

 * create a policy file as policy.hcl

 ```
 path "auth/approle/login" {
  capabilities = [ "create", "read" ]
 }


 path "secret/*" {
  capabilities = [ "create", "read", "update", "list" ]
 }
 ```
**To create a policy by**

```
./vault policy write k8stoken policy.hcl

```
**To create a role in Vault and associate the policy with that role**

```
./vault write auth/approle/role/k8s-role token_ttl=6h policies="k8stoken"

```
**Role ID for the k8s-role role can be fetched by**

```
./vault read auth/approle/role/k8s-role/role-id

```
**secret ID for the k8s-role is generated by**

```
./vault write -f auth/approle/role/k8s-role/secret-id

```
**To login to the k8s-role by**

   ```

   ./vault  write auth/approle/login role_id=xxxxxxx  secret_id=xxxxxxxxx


   ```

**To run the script token.sh. In the script we have to cd to the path where vault binary is there.**

   ```

   ./token.sh

   ```


### On master we have to run following commands

```

export KUBECONFIG=/etc/kubernetes/admin.conf

sysctl net.bridge.bridge-nf-call-iptables=1

kubeadm init --kubernetes-version=1.12.1 API.ControlPlaneEndpoint=master_lb_DNS:443 --pod-network-cidr=10.244.0.0/16

sha_key=$(openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //')

/root/vault write secret/SHAKEY key=$sha_key

kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml

kubectl get nodes

sh /root/AppZ-Images/k8s/scripts/token.sh

setup cron job as 0 */6 * * * sh /root/AppZ-Images/k8s/scripts/token.sh


```
